<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Command Center</title>
  <style>
    :root{
      --bg:#0d1117; --card:#161b22; --border:#30363d; --text:#e6edf3; --muted:#8b949e;
      --red:#f85149; --orange:#f0883e; --yellow:#d29922; --green:#3fb950;
      --cp:#a371f7; --bo:#f0883e; --kf:#58a6ff;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); background:var(--bg); color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1200px; margin:0 auto; padding:18px 14px 44px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; position:sticky; top:0; z-index:10; padding:14px 14px; margin:-18px -14px 16px; background:rgba(13,17,23,.92); backdrop-filter:saturate(140%) blur(10px); border-bottom:1px solid var(--border)}
    .title{display:flex; align-items:baseline; gap:12px}
    h1{font-size:16px; letter-spacing:.12em; margin:0; text-transform:uppercase}
    .sub{color:var(--muted); font-size:12px}
    .toolbar{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    button, .btn{appearance:none; border:1px solid var(--border); background:transparent; color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:12px}
    button:hover, .btn:hover{border-color:#6e7681}
    button.primary{background:#238636; border-color:#238636}
    button.primary:hover{filter:brightness(1.05)}
    button.danger{background:transparent; border-color:rgba(248,81,73,.5); color:var(--text)}
    button.danger:hover{border-color:var(--red)}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow)}
    .card .hd{padding:14px 14px 10px; border-bottom:1px solid rgba(48,54,61,.6); display:flex; align-items:center; justify-content:space-between; gap:12px}
    .card .hd h2{margin:0; font-size:13px; letter-spacing:.08em; text-transform:uppercase}
    .card .bd{padding:12px 14px}

    .stats{grid-column:1/-1; display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    .stat{padding:14px; border-radius:14px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));}
    .stat .k{font-size:11px; letter-spacing:.12em; text-transform:uppercase; color:var(--muted)}
    .stat .v{font-size:28px; font-weight:700; margin-top:6px}
    .stat .d{font-size:12px; color:var(--muted); margin-top:2px}
    .stat.red{border-color:rgba(248,81,73,.35)}
    .stat.yellow{border-color:rgba(210,153,34,.35)}
    .stat.orange{border-color:rgba(240,136,62,.35)}

    .section{grid-column:1/-1}
    .tableWrap{overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(48,54,61,.55); font-size:12px; vertical-align:middle}
    th{position:sticky; top:0; background:rgba(22,27,34,.96); backdrop-filter:blur(6px); text-align:left; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; font-size:11px}
    tr:hover td{background:rgba(110,118,129,.08)}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); font-size:11px; color:var(--text)}
    .pill.cp{border-color:rgba(163,113,247,.55)}
    .pill.bo{border-color:rgba(240,136,62,.65)}
    .pill.kf{border-color:rgba(88,166,255,.55)}

    .days{font-family:var(--mono); font-weight:700}
    .days.crit{color:var(--red)}
    .days.warn{color:var(--orange)}
    .days.watch{color:var(--yellow)}
    .days.good{color:var(--green)}

    .muted{color:var(--muted)}
    .right{display:flex; align-items:center; justify-content:flex-end}
    .controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .controls label{font-size:12px; color:var(--muted); display:flex; align-items:center; gap:8px}
    input[type="number"], input[type="text"], select{background:rgba(255,255,255,.04); border:1px solid var(--border); color:var(--text); border-radius:10px; padding:7px 9px; font-size:12px; outline:none}
    input[type="number"]{width:92px}
    .seg{display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .seg button{border:0; border-right:1px solid var(--border); border-radius:0; padding:8px 10px; background:transparent}
    .seg button:last-child{border-right:0}
    .seg button.active{background:rgba(88,166,255,.14); border-color:transparent}

    .twoCol{display:grid; grid-template-columns:1.4fr 1fr; gap:12px}
    @media (max-width: 980px){
      .twoCol{grid-template-columns:1fr}
      .stats{grid-template-columns:1fr}
      header{position:relative}
    }

    .empty{padding:14px; border:1px dashed rgba(139,148,158,.35); border-radius:12px; color:var(--muted); font-size:12px}
    .small{font-size:11px}

    .rowAction{display:flex; gap:8px; align-items:center; justify-content:flex-end}
    .check{transform: translateY(1px);}

    .callout{padding:10px 12px; border:1px solid rgba(88,166,255,.25); background:rgba(88,166,255,.08); border-radius:12px; color:var(--text); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>üéØ Command Center</h1>
        <div class="sub" id="syncLine">Loading‚Ä¶</div>
      </div>
      <div class="toolbar">
        <button id="btnRefresh">‚ü≥ Refresh</button>
        <button class="primary" id="btnExportReorder">Export Reorder CSV</button>
        <button id="btnExportXmas">Export Christmas CSV</button>
      </div>
    </header>

    <div class="stats" id="stats"></div>

    <div class="grid">
      <div class="card section">
        <div class="hd">
          <h2>üì¶ Reorder Now ‚Äî Under <span id="reorderThresholdLabel">60</span> Days Runway</h2>
          <div class="controls">
            <label>Reorder &lt; <input type="number" min="1" max="365" step="1" id="reorderDays" value="60" /> days</label>
            <label>Watch  <input type="number" min="1" max="365" step="1" id="watchDays" value="90" /> days</label>
            <label>Min vel <input type="number" min="0" max="50" step="0.1" id="minVel" value="0.5" /> /day</label>
            <label>Margin <input type="number" min="0" max="0.95" step="0.01" id="marginRate" value="0.25" /> (est.)</label>
          </div>
        </div>
        <div class="bd">
          <div class="callout small">
            Sorting is profit-impact first: <span class="muted">(est. profit/unit √ó daily velocity)</span>. Margin is an estimate until Sellerboard profit per unit is wired in.
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="min-width:260px">Product</th>
                  <th>Brand</th>
                  <th class="right">Days</th>
                  <th class="right">Stock</th>
                  <th class="right">Vel</th>
                  <th class="right">Est. Profit/u</th>
                  <th class="right">Impact/day</th>
                  <th class="right">Select</th>
                </tr>
              </thead>
              <tbody id="reorderTbody"></tbody>
            </table>
          </div>
          <div id="reorderEmpty" class="empty" style="display:none; margin-top:10px"></div>
        </div>
      </div>

      <div class="card section">
        <div class="hd">
          <h2>üéÑ Christmas Planning ‚Äî Q4 Restock Projections</h2>
          <div class="controls">
            <div class="seg" id="xmasSeg">
              <button data-m="1.5">1.5√ó</button>
              <button data-m="2" class="active">2√ó</button>
              <button data-m="2.5">2.5√ó</button>
              <button data-m="custom">Custom</button>
            </div>
            <label>Multiplier <input type="number" min="0.5" max="6" step="0.1" id="xmasMultiplier" value="2" /></label>
            <label>Lead time <input type="number" min="1" max="200" step="1" id="leadTime" value="75" /> days</label>
            <label>MOQ <input type="number" min="1" max="5000" step="1" id="moq" value="500" /></label>
          </div>
        </div>
        <div class="bd">
          <div class="twoCol">
            <div>
              <div class="muted small" id="xmasMeta"></div>
            </div>
            <div class="right">
              <label class="small muted">Show top <input type="number" min="5" max="100" step="5" id="xmasTop" value="20" /></label>
            </div>
          </div>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="min-width:260px">Product</th>
                  <th>Brand</th>
                  <th class="right">Need (Oct‚ÜíDec)</th>
                  <th class="right">Current</th>
                  <th class="right">Gap</th>
                  <th class="right">Order Qty</th>
                  <th class="right">Vel (base)</th>
                </tr>
              </thead>
              <tbody id="xmasTbody"></tbody>
            </table>
          </div>
          <div id="xmasEmpty" class="empty" style="display:none; margin-top:10px"></div>
        </div>
      </div>

      <div class="card section">
        <div class="hd">
          <h2>‚ö†Ô∏è Suppression Alerts</h2>
          <div class="controls">
            <label>Show <select id="suppressionFilter">
              <option value="suppressed">Suppressed only</option>
              <option value="all">All</option>
            </select></label>
          </div>
        </div>
        <div class="bd">
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>ASIN</th>
                  <th style="min-width:260px">Product</th>
                  <th>Brand</th>
                  <th>Status</th>
                  <th>Last Checked</th>
                  <th class="right">Days Since</th>
                  <th class="right">Action</th>
                </tr>
              </thead>
              <tbody id="suppTbody"></tbody>
            </table>
          </div>
          <div id="suppEmpty" class="empty" style="display:none; margin-top:10px"></div>
        </div>
      </div>

      <div class="card section">
        <div class="hd">
          <h2>üêå Slow Movers ‚Äî Consider Liquidation</h2>
          <div class="controls">
            <button id="toggleSlow">Show</button>
            <label>Runway &gt; <input type="number" min="30" max="9999" step="10" id="slowRunway" value="180" /> days</label>
            <label>Vel &lt; <input type="number" min="0" max="10" step="0.1" id="slowVel" value="1" /> /day</label>
          </div>
        </div>
        <div class="bd" id="slowBody" style="display:none">
          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th style="min-width:260px">Product</th>
                  <th>Brand</th>
                  <th class="right">Runway</th>
                  <th class="right">Stock</th>
                  <th class="right">Vel</th>
                </tr>
              </thead>
              <tbody id="slowTbody"></tbody>
            </table>
          </div>
          <div id="slowEmpty" class="empty" style="display:none; margin-top:10px"></div>
        </div>
      </div>

    </div>
  </div>

<script>
  const BRAND_META = {
    cardplug: { label: 'CP', cls: 'cp' },
    blackowned: { label: 'BO', cls: 'bo' },
    kinfolk: { label: 'KF', cls: 'kf' }
  };

  function fmtNum(n, digits=0){
    if (n === null || n === undefined || Number.isNaN(n)) return '‚Äî';
    return Number(n).toLocaleString(undefined, {maximumFractionDigits:digits, minimumFractionDigits:digits});
  }
  function fmtMoney(n, digits=2){
    if (n === null || n === undefined || Number.isNaN(n)) return '‚Äî';
    return '$' + Number(n).toLocaleString(undefined, {maximumFractionDigits:digits, minimumFractionDigits:digits});
  }
  function daysClass(days){
    if (!isFinite(days)) return 'good';
    if (days < 30) return 'crit';
    if (days < 60) return 'warn';
    if (days < 90) return 'watch';
    return 'good';
  }
  function brandPill(brandKey){
    const b = BRAND_META[brandKey] || {label: brandKey?.slice(0,2)?.toUpperCase() || '‚Äî', cls:''};
    return `<span class="pill ${b.cls}">${b.label}</span>`;
  }

  function parseCSV(text){
    // Minimal CSV parser supporting quoted fields
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    while (i < text.length){
      const c = text[i];
      if (inQuotes){
        if (c === '"'){
          if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        field += c; i++; continue;
      }
      if (c === '"'){ inQuotes = true; i++; continue; }
      if (c === ','){ row.push(field); field=''; i++; continue; }
      if (c === '\n'){
        row.push(field); field='';
        if (row.length === 1 && row[0] === ''){ row = []; i++; continue; }
        rows.push(row); row=[]; i++; continue;
      }
      if (c === '\r'){ i++; continue; }
      field += c; i++;
    }
    if (field.length || row.length){ row.push(field); rows.push(row); }
    const header = rows.shift() || [];
    return rows.map(r => {
      const obj = {};
      header.forEach((h, idx) => obj[h.trim()] = (r[idx] ?? '').trim());
      return obj;
    });
  }

  function downloadCSV(filename, rows){
    const esc = (v) => {
      const s = String(v ?? '');
      if (/[\n\r,\"]/g.test(s)) return '"' + s.replaceAll('"', '""') + '"';
      return s;
    };
    const header = Object.keys(rows[0] || {});
    const lines = [header.join(',')].concat(rows.map(r => header.map(h => esc(r[h])).join(',')));
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // State
  let reorderData = null;
  let velocityData = null;
  let suppressionRows = null;
  const selectedReorder = new Set();

  async function loadAll(){
    const [rr, sv, sup] = await Promise.all([
      fetch('data/reorder_report.json', {cache:'no-store'}).then(r=>r.json()),
      fetch('data/sku_velocity.json', {cache:'no-store'}).then(r=>r.json()),
      fetch('data/suppression_tracker.csv', {cache:'no-store'}).then(r=>r.text()),
    ]);
    reorderData = rr;
    velocityData = sv;
    suppressionRows = parseCSV(sup);

    // defaults from config
    if (rr?.config?.lead_time_days) document.getElementById('leadTime').value = rr.config.lead_time_days;
    if (rr?.config?.moq) document.getElementById('moq').value = rr.config.moq;

    renderAll();
  }

  function getAllSkusFromReorderReport(){
    const out = [];
    const brands = reorderData?.brands || {};
    for (const [brandKey, b] of Object.entries(brands)){
      const skus = b?.skus || [];
      for (const s of skus){
        out.push({
          brandKey,
          sku: s.sku,
          asin: s.asin,
          name: s.name,
          fba_qty: Number(s.fba_qty ?? 0),
          runway_days: Number(s.runway_days ?? Infinity),
          daily_velocity_rr: Number(s.daily_velocity ?? 0)
        });
      }
    }
    return out;
  }

  function getVelocityForSku(brandKey, sku){
    const v = velocityData?.brands?.[brandKey]?.skus?.[sku];
    if (!v) return null;
    return {
      daily_velocity: Number(v.daily_velocity ?? 0),
      units_90d: Number(v.units_90d ?? 0),
      revenue_90d: Number(v.revenue_90d ?? 0),
      daily_revenue: Number(v.daily_revenue ?? 0)
    };
  }

  function enrichSku(row){
    const vel = getVelocityForSku(row.brandKey, row.sku);
    const dailyVel = (vel && isFinite(vel.daily_velocity)) ? vel.daily_velocity : row.daily_velocity_rr;
    const avgPrice = (vel && vel.units_90d > 0) ? (vel.revenue_90d / vel.units_90d) : null;
    return { ...row, daily_velocity: dailyVel, avg_price: avgPrice };
  }

  function computeEstProfitPerUnit(avgPrice, marginRate){
    if (!isFinite(avgPrice) || !isFinite(marginRate)) return null;
    return avgPrice * marginRate;
  }

  function renderStats(){
    const reorderDays = Number(document.getElementById('reorderDays').value);
    const watchDays = Number(document.getElementById('watchDays').value);
    const minVel = Number(document.getElementById('minVel').value);

    const all = getAllSkusFromReorderReport().map(enrichSku);
    const reorder = all.filter(x => x.runway_days < reorderDays && x.daily_velocity > minVel);
    const watch = all.filter(x => x.runway_days >= reorderDays && x.runway_days < watchDays && x.daily_velocity > minVel);
    const suppressed = (suppressionRows || []).filter(r => (r.Status || '').toLowerCase() === 'suppressed');

    const stats = document.getElementById('stats');
    stats.innerHTML = `
      <div class="stat red">
        <div class="k">üî¥ Reorder</div>
        <div class="v">${fmtNum(reorder.length)}</div>
        <div class="d">Need action</div>
      </div>
      <div class="stat yellow">
        <div class="k">üü° Watch</div>
        <div class="v">${fmtNum(watch.length)}</div>
        <div class="d">Monitor</div>
      </div>
      <div class="stat orange">
        <div class="k">‚ö†Ô∏è Suppressed</div>
        <div class="v">${fmtNum(suppressed.length)}</div>
        <div class="d">Fix now</div>
      </div>
    `;
  }

  function renderReorder(){
    const reorderDays = Number(document.getElementById('reorderDays').value);
    const minVel = Number(document.getElementById('minVel').value);
    const marginRate = Number(document.getElementById('marginRate').value);

    document.getElementById('reorderThresholdLabel').textContent = String(reorderDays);

    const all = getAllSkusFromReorderReport().map(enrichSku);
    const rows = all
      .filter(x => x.runway_days < reorderDays && x.daily_velocity > minVel)
      .map(x => {
        const profitUnit = computeEstProfitPerUnit(x.avg_price, marginRate);
        const impactPerDay = (isFinite(profitUnit) ? profitUnit : 0) * (isFinite(x.daily_velocity) ? x.daily_velocity : 0);
        return { ...x, est_profit_unit: profitUnit, impact_per_day: impactPerDay };
      })
      .sort((a,b) => (b.impact_per_day - a.impact_per_day) || (a.runway_days - b.runway_days));

    const tbody = document.getElementById('reorderTbody');
    tbody.innerHTML = rows.map(r => {
      const checked = selectedReorder.has(r.sku) ? 'checked' : '';
      return `
        <tr>
          <td title="${(r.name||'').replaceAll('"','&quot;')}">${r.name || '‚Äî'}</td>
          <td>${brandPill(r.brandKey)}</td>
          <td class="right"><span class="days ${daysClass(r.runway_days)}">${fmtNum(r.runway_days,0)}</span></td>
          <td class="right">${fmtNum(r.fba_qty,0)}</td>
          <td class="right">${fmtNum(r.daily_velocity,2)}</td>
          <td class="right">${fmtMoney(r.est_profit_unit,2)}</td>
          <td class="right">${fmtMoney(r.impact_per_day,2)}</td>
          <td class="right"><input class="check" type="checkbox" data-sku="${r.sku}" ${checked} /></td>
        </tr>
      `;
    }).join('');

    const empty = document.getElementById('reorderEmpty');
    if (rows.length === 0){
      empty.style.display = 'block';
      empty.textContent = 'No SKUs currently meet the Reorder criteria (try raising the threshold or lowering min velocity).';
    } else empty.style.display = 'none';

    tbody.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const sku = e.target.getAttribute('data-sku');
        if (e.target.checked) selectedReorder.add(sku); else selectedReorder.delete(sku);
      });
    });
  }

  function renderChristmas(){
    const multiplier = Number(document.getElementById('xmasMultiplier').value);
    const leadTime = Number(document.getElementById('leadTime').value);
    const moq = Number(document.getElementById('moq').value);
    const topN = Number(document.getElementById('xmasTop').value);

    const now = new Date();
    const year = now.getFullYear();
    const oct1 = new Date(Date.UTC(year, 9, 1)); // Oct=9 (0-index) in UTC
    const dec31 = new Date(Date.UTC(year, 11, 31));
    const msDay = 86400000;

    const daysToOct1 = Math.ceil((oct1 - new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()))) / msDay);
    const q4Days = Math.max(0, Math.ceil((dec31 - oct1) / msDay) + 1);
    const orderBy = new Date(oct1.getTime() - (leadTime * msDay));

    document.getElementById('xmasMeta').innerHTML = `Using baseline velocity √ó <b>${fmtNum(multiplier,1)}√ó</b> for <b>${fmtNum(q4Days,0)}</b> days (Oct 1 ‚Üí Dec 31).<br>
      Lead time: <b>${fmtNum(leadTime,0)}</b> days. Order-by date: <b>${orderBy.toISOString().slice(0,10)}</b>. Days until Oct 1: <b>${fmtNum(daysToOct1,0)}</b>.`;

    const all = getAllSkusFromReorderReport().map(enrichSku);
    const rows = all
      .filter(x => x.daily_velocity > 0) // only things that sell
      .map(x => {
        const need = x.daily_velocity * multiplier * q4Days;
        const gap = Math.max(0, Math.ceil(need - x.fba_qty));
        let orderQty = gap;
        if (orderQty > 0 && isFinite(moq) && moq > 0){
          orderQty = Math.ceil(orderQty / moq) * moq;
        }
        return { ...x, need_units: Math.ceil(need), gap_units: gap, order_qty: orderQty };
      })
      .sort((a,b) => (b.gap_units - a.gap_units) || (b.daily_velocity - a.daily_velocity))
      .slice(0, Math.max(1, topN));

    const tbody = document.getElementById('xmasTbody');
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td title="${(r.name||'').replaceAll('"','&quot;')}">${r.name || '‚Äî'}</td>
        <td>${brandPill(r.brandKey)}</td>
        <td class="right">${fmtNum(r.need_units,0)}</td>
        <td class="right">${fmtNum(r.fba_qty,0)}</td>
        <td class="right">${fmtNum(r.gap_units,0)}</td>
        <td class="right">${fmtNum(r.order_qty,0)}</td>
        <td class="right">${fmtNum(r.daily_velocity,2)}</td>
      </tr>
    `).join('');

    const empty = document.getElementById('xmasEmpty');
    if (rows.length === 0){
      empty.style.display = 'block';
      empty.textContent = 'No velocity data available for Christmas planning.';
    } else empty.style.display = 'none';
  }

  function renderSuppression(){
    const mode = document.getElementById('suppressionFilter').value;
    const now = new Date();
    const msDay = 86400000;

    let rows = (suppressionRows || []).map(r => {
      const last = r['Last Checked'] ? new Date(r['Last Checked'] + 'T00:00:00') : null;
      const daysSince = last ? Math.floor((now - last) / msDay) : null;
      return { ...r, _last: last, _daysSince: daysSince };
    });

    if (mode === 'suppressed') rows = rows.filter(r => (r.Status || '').toLowerCase() === 'suppressed');

    // suppressed first
    rows.sort((a,b) => {
      const sa = (a.Status || '').toLowerCase() === 'suppressed' ? 0 : 1;
      const sb = (b.Status || '').toLowerCase() === 'suppressed' ? 0 : 1;
      return sa - sb || (b._daysSince ?? 0) - (a._daysSince ?? 0);
    });

    const tbody = document.getElementById('suppTbody');
    tbody.innerHTML = rows.map(r => {
      const status = (r.Status || '‚Äî');
      const isSupp = status.toLowerCase() === 'suppressed';
      const fixUrl = `https://sellercentral.amazon.com/listing-quality`; // placeholder action
      return `
        <tr>
          <td style="font-family:var(--mono)">${r.ASIN || '‚Äî'}</td>
          <td>${r.Name || '‚Äî'}</td>
          <td>${r.Brand || '‚Äî'}</td>
          <td style="color:${isSupp ? 'var(--red)' : 'var(--muted)'}; font-weight:${isSupp ? 700 : 400}">${status}</td>
          <td>${r['Last Checked'] || '‚Äî'}</td>
          <td class="right">${r._daysSince === null ? '‚Äî' : fmtNum(r._daysSince,0)}</td>
          <td class="right"><a class="btn" href="${fixUrl}" target="_blank" rel="noreferrer">Fix ‚Üí</a></td>
        </tr>
      `;
    }).join('');

    const empty = document.getElementById('suppEmpty');
    if (rows.length === 0){
      empty.style.display = 'block';
      empty.textContent = mode === 'suppressed' ? 'No suppressed ASINs found.' : 'No suppression data found.';
    } else empty.style.display = 'none';
  }

  function renderSlowMovers(){
    const runwayMin = Number(document.getElementById('slowRunway').value);
    const velMax = Number(document.getElementById('slowVel').value);

    const all = getAllSkusFromReorderReport().map(enrichSku);
    const rows = all
      .filter(x => x.runway_days > runwayMin && x.daily_velocity < velMax)
      .sort((a,b) => (b.runway_days - a.runway_days) || (a.daily_velocity - b.daily_velocity))
      .slice(0, 200);

    const tbody = document.getElementById('slowTbody');
    tbody.innerHTML = rows.map(r => `
      <tr>
        <td title="${(r.name||'').replaceAll('"','&quot;')}">${r.name || '‚Äî'}</td>
        <td>${brandPill(r.brandKey)}</td>
        <td class="right"><span class="days ${daysClass(r.runway_days)}">${fmtNum(r.runway_days,0)}</span></td>
        <td class="right">${fmtNum(r.fba_qty,0)}</td>
        <td class="right">${fmtNum(r.daily_velocity,2)}</td>
      </tr>
    `).join('');

    const empty = document.getElementById('slowEmpty');
    if (rows.length === 0){
      empty.style.display = 'block';
      empty.textContent = 'No slow movers matched these thresholds.';
    } else empty.style.display = 'none';
  }

  function renderSyncLine(){
    const t = reorderData?.timestamp ? new Date(reorderData.timestamp) : null;
    const ts = t ? t.toLocaleString() : '‚Äî';
    document.getElementById('syncLine').textContent = `Last sync: ${ts}`;
  }

  function renderAll(){
    renderSyncLine();
    renderStats();
    renderReorder();
    renderChristmas();
    renderSuppression();
    renderSlowMovers();
  }

  function wireUI(){
    const rerenderIds = ['reorderDays','watchDays','minVel','marginRate','xmasMultiplier','leadTime','moq','xmasTop','suppressionFilter','slowRunway','slowVel'];
    rerenderIds.forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        if (id === 'reorderDays') document.getElementById('reorderThresholdLabel').textContent = document.getElementById('reorderDays').value;
        renderAll();
      });
      document.getElementById(id).addEventListener('change', renderAll);
    });

    document.getElementById('btnRefresh').addEventListener('click', async () => {
      selectedReorder.clear();
      await loadAll();
    });

    document.getElementById('btnExportReorder').addEventListener('click', () => {
      const marginRate = Number(document.getElementById('marginRate').value);
      const rows = getAllSkusFromReorderReport().map(enrichSku)
        .filter(x => selectedReorder.has(x.sku))
        .map(x => {
          const estProfitUnit = computeEstProfitPerUnit(x.avg_price, marginRate);
          return {
            sku: x.sku,
            asin: x.asin,
            brand: x.brandKey,
            name: x.name,
            fba_qty: x.fba_qty,
            runway_days: fmtNum(x.runway_days,0),
            daily_velocity: fmtNum(x.daily_velocity,2),
            est_profit_per_unit: estProfitUnit === null ? '' : estProfitUnit.toFixed(2)
          };
        });
      if (rows.length === 0){
        alert('Select at least 1 SKU in Reorder Now to export.');
        return;
      }
      downloadCSV(`command_center_reorder_${new Date().toISOString().slice(0,10)}.csv`, rows);
    });

    document.getElementById('btnExportXmas').addEventListener('click', () => {
      const multiplier = Number(document.getElementById('xmasMultiplier').value);
      const leadTime = Number(document.getElementById('leadTime').value);
      const moq = Number(document.getElementById('moq').value);

      const now = new Date();
      const year = now.getFullYear();
      const oct1 = new Date(Date.UTC(year, 9, 1));
      const dec31 = new Date(Date.UTC(year, 11, 31));
      const msDay = 86400000;
      const q4Days = Math.max(0, Math.ceil((dec31 - oct1) / msDay) + 1);

      const all = getAllSkusFromReorderReport().map(enrichSku)
        .filter(x => x.daily_velocity > 0)
        .map(x => {
          const need = x.daily_velocity * multiplier * q4Days;
          const gap = Math.max(0, Math.ceil(need - x.fba_qty));
          let orderQty = gap;
          if (orderQty > 0 && isFinite(moq) && moq > 0){
            orderQty = Math.ceil(orderQty / moq) * moq;
          }
          return {
            sku: x.sku,
            asin: x.asin,
            brand: x.brandKey,
            name: x.name,
            base_daily_velocity: x.daily_velocity.toFixed(2),
            multiplier,
            q4_days: q4Days,
            need_units: Math.ceil(need),
            current_fba_qty: x.fba_qty,
            gap_units: gap,
            moq,
            suggested_order_qty: orderQty,
            lead_time_days: leadTime
          };
        })
        .sort((a,b) => b.gap_units - a.gap_units);

      if (all.length === 0){
        alert('No SKUs available for export.');
        return;
      }
      downloadCSV(`command_center_christmas_${new Date().toISOString().slice(0,10)}.csv`, all);
    });

    // multiplier presets
    document.getElementById('xmasSeg').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      document.querySelectorAll('#xmasSeg button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const m = btn.getAttribute('data-m');
      const input = document.getElementById('xmasMultiplier');
      if (m === 'custom'){
        input.focus();
        input.select?.();
      } else {
        input.value = m;
        renderChristmas();
      }
    });

    // slow movers toggle
    document.getElementById('toggleSlow').addEventListener('click', () => {
      const body = document.getElementById('slowBody');
      const btn = document.getElementById('toggleSlow');
      const show = body.style.display === 'none';
      body.style.display = show ? 'block' : 'none';
      btn.textContent = show ? 'Hide' : 'Show';
      if (show) renderSlowMovers();
    });
  }

  wireUI();
  loadAll().catch(err => {
    console.error(err);
    document.getElementById('syncLine').textContent = 'Error loading data ‚Äî check console';
  });
</script>
</body>
</html>
