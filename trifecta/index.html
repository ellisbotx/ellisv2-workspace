<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trifecta Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            min-height: 100vh;
            padding: 40px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff, #a371f7, #f778ba);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .period {
            color: #8b949e;
            font-size: 14px;
        }
        
        .period span {
            color: #58a6ff;
            font-weight: 600;
        }
        
        /* Top Metrics */
        .top-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .metric-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 28px;
        }
        
        .metric-card.highlight {
            border-color: #388bfd;
            box-shadow: 0 0 20px rgba(56, 139, 253, 0.1);
        }
        
        .metric-label {
            font-size: 14px;
            color: #8b949e;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .metric-value.profit {
            color: #3fb950;
        }
        
        .metric-change {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .metric-change.down {
            color: #f85149;
        }
        
        .metric-change.up {
            color: #3fb950;
        }
        
        /* Brand Cards */
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #8b949e;
        }
        
        .brand-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .brand-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
        }
        
        .brand-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #30363d;
        }
        
        .brand-name.black-owned { color: #f0883e; }
        .brand-name.cardplug { color: #a371f7; }
        .brand-name.kinfolk { color: #58a6ff; }
        
        .brand-stats {
            display: grid;
            gap: 16px;
        }
        
        .brand-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brand-stat-label {
            color: #8b949e;
            font-size: 14px;
        }
        
        .brand-stat-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .brand-stat-value.profit {
            color: #3fb950;
        }
        
        /* ASIN Monitor Section - Redesigned */
        .asin-monitor {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 40px;
        }
        
        .asin-monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
        }
        
        .asin-health {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .health-ring {
            position: relative;
            width: 100px;
            height: 100px;
        }
        
        .health-ring svg {
            transform: rotate(-90deg);
            width: 100px;
            height: 100px;
        }
        
        .health-ring-bg {
            fill: none;
            stroke: #21262d;
            stroke-width: 8;
        }
        
        .health-ring-progress {
            fill: none;
            stroke: #3fb950;
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 251.2;
            stroke-dashoffset: 0;
            transition: stroke-dashoffset 0.5s ease;
        }
        
        .health-ring-progress.warning {
            stroke: #d29922;
        }
        
        .health-ring-progress.danger {
            stroke: #f85149;
        }
        
        .health-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .health-percent {
            font-size: 24px;
            font-weight: 700;
            color: #3fb950;
        }
        
        .health-percent.warning { color: #d29922; }
        .health-percent.danger { color: #f85149; }
        
        .health-label {
            font-size: 11px;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .asin-health-info h3 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 6px;
            color: #3fb950;
        }
        
        .asin-health-info h3.warning { color: #d29922; }
        .asin-health-info h3.danger { color: #f85149; }
        
        .asin-health-info p {
            color: #8b949e;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .last-checked {
            font-size: 12px;
            color: #484f58;
        }
        
        .last-checked span {
            color: #8b949e;
        }
        
        .brand-pills {
            display: flex;
            gap: 12px;
        }
        
        .brand-pill {
            background: #21262d;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .brand-pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .brand-pill-dot.black-owned { background: #f0883e; }
        .brand-pill-dot.cardplug { background: #a371f7; }
        .brand-pill-dot.kinfolk { background: #58a6ff; }
        
        .brand-pill-count {
            color: #8b949e;
        }
        
        .brand-pill-count span {
            color: #e6edf3;
            font-weight: 600;
        }
        
        .brand-pill-count span.alert {
            color: #f85149;
        }
        
        /* Suppression List - Redesigned */
        .suppression-section {
            border-top: 1px solid #30363d;
            padding-top: 24px;
        }
        
        .suppression-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .suppression-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .suppression-count-badge {
            background: #f85149;
            color: #fff;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        .suppression-count-badge.clear {
            background: #238636;
        }
        
        .suppression-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .suppression-card {
            background: linear-gradient(135deg, rgba(248, 81, 73, 0.1) 0%, rgba(248, 81, 73, 0.05) 100%);
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .suppression-card-icon {
            width: 36px;
            height: 36px;
            background: rgba(248, 81, 73, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .suppression-card-content {
            flex: 1;
            min-width: 0;
        }
        
        .suppression-card-brand {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .suppression-card-brand.black-owned { color: #f0883e; }
        .suppression-card-brand.cardplug { color: #a371f7; }
        .suppression-card-brand.kinfolk { color: #58a6ff; }
        
        .suppression-card-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suppression-card-asin {
            font-size: 12px;
            color: #8b949e;
            font-family: 'SF Mono', Monaco, monospace;
        }
        
        .suppression-card-days {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }
        
        .all-clear-message {
            text-align: center;
            padding: 24px;
            background: rgba(35, 134, 54, 0.1);
            border: 1px solid rgba(35, 134, 54, 0.2);
            border-radius: 10px;
        }
        
        .all-clear-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .all-clear-text {
            color: #3fb950;
            font-weight: 500;
        }
        
        /* Suppressed List */
        .suppressed-list {
            display: grid;
            gap: 12px;
            margin-top: 16px;
        }
        
        .suppressed-item {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.2);
            border-radius: 8px;
            padding: 16px;
        }
        
        .suppressed-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .suppressed-item-header strong {
            font-size: 15px;
            color: #e6edf3;
        }
        
        .brand-tag {
            font-size: 12px;
            padding: 4px 8px;
            background: rgba(88, 166, 255, 0.2);
            color: #58a6ff;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .suppressed-item-details {
            display: grid;
            gap: 4px;
            font-size: 13px;
            color: #8b949e;
        }
        
        /* Alerts Section */
        .alerts {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 24px;
        }
        
        .alert-list {
            display: grid;
            gap: 12px;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #0d1117;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .alert-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .alert-dot.red { background: #f85149; }
        .alert-dot.yellow { background: #d29922; }
        .alert-dot.green { background: #3fb950; }
        
        .updated {
            text-align: center;
            margin-top: 40px;
            color: #484f58;
            font-size: 12px;
        }

        /* Overall health badge (uses existing palette) */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #30363d;
            background: #161b22;
            color: #8b949e;
        }
        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #8b949e;
        }
        .health-badge.good { border-color: rgba(63, 185, 80, 0.35); color: #3fb950; }
        .health-badge.good .health-dot { background: #3fb950; }
        .health-badge.warn { border-color: rgba(210, 153, 34, 0.35); color: #d29922; }
        .health-badge.warn .health-dot { background: #d29922; }
        .health-badge.bad { border-color: rgba(248, 81, 73, 0.35); color: #f85149; }
        .health-badge.bad .health-dot { background: #f85149; }

        .mini-metric {
            margin-top: 10px;
            font-size: 13px;
            color: #8b949e;
        }
        .mini-metric strong { color: #e6edf3; }
    </style>
</head>
<body>
    <style>
        .nav-tabs {
            display: flex;
            gap: 8px;
        }
        .nav-tab {
            padding: 10px 20px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            color: #8b949e;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-tab:hover { background: #30363d; color: #e6edf3; }
        .nav-tab.active { background: #388bfd; border-color: #388bfd; color: #fff; }
    </style>
    <div class="header">
        <div style="display:flex;align-items:center;gap:12px;">
            <div class="logo">▲ Trifecta</div>
            <div id="overallHealthBadge" class="health-badge" title="Derived from stockouts, suppressions, and revenue trend">
                <span class="health-dot"></span>
                <span id="overallHealthText">Health: —</span>
            </div>
        </div>
        <div class="nav-tabs">
            <a href="index.html" class="nav-tab active">Overview</a>
            <a href="inventory.html" class="nav-tab">Inventory</a>
            <a href="products.html" class="nav-tab">Products</a>
            <a href="profitability.html" class="nav-tab">Profitability</a>
        </div>
    </div>
    
    <div class="top-metrics">
        <div class="metric-card highlight">
            <div class="metric-label">Total Sales (30d)</div>
            <div class="metric-value">$52,970</div>
            <div class="metric-change" style="color:#8b949e;">
                Yesterday: <strong style="color:#58a6ff;">$1,576</strong> (74 units)
            </div>
            <div class="mini-metric">
                Last 7d: <strong id="rev7Value">—</strong> <span id="rev7Trend" style="margin-left:6px;"></span>
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">Total Profit (30d)</div>
            <div class="metric-value profit">$15,891</div>
            <div class="metric-change" style="color:#8b949e;">
                Yesterday: <strong style="color:#3fb950;">$473</strong> (est)
            </div>
        </div>
        
        <div class="metric-card">
            <div class="metric-label">Profit Margin</div>
            <div class="metric-value">30.0%</div>
            <div class="metric-change" style="color:#8b949e;">
                Est. until Sellerboard connected
            </div>
        </div>
    </div>
    
    <div class="section-title">By Brand (30 Days)</div>
    <div class="brand-grid">
        <div class="brand-card">
            <div class="brand-name black-owned">Black Owned</div>
            <div class="brand-stats">
                <div class="brand-stat">
                    <span class="brand-stat-label">Sales (30d)</span>
                    <span class="brand-stat-value">$17,874</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Yesterday</span>
                    <span class="brand-stat-value" style="color:#58a6ff;">$671</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Units (30d)</span>
                    <span class="brand-stat-value">732</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Margin</span>
                    <span class="brand-stat-value">30%</span>
                </div>
            </div>
        </div>
        
        <div class="brand-card">
            <div class="brand-name cardplug">Card Plug</div>
            <div class="brand-stats">
                <div class="brand-stat">
                    <span class="brand-stat-label">Sales (30d)</span>
                    <span class="brand-stat-value">$19,696</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Yesterday</span>
                    <span class="brand-stat-value" style="color:#58a6ff;">$534</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Units (30d)</span>
                    <span class="brand-stat-value">996</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Margin</span>
                    <span class="brand-stat-value">30%</span>
                </div>
            </div>
        </div>
        
        <div class="brand-card">
            <div class="brand-name kinfolk">Kinfolk</div>
            <div class="brand-stats">
                <div class="brand-stat">
                    <span class="brand-stat-label">Sales (30d)</span>
                    <span class="brand-stat-value">$15,361</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Yesterday</span>
                    <span class="brand-stat-value" style="color:#58a6ff;">$372</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Units (30d)</span>
                    <span class="brand-stat-value">728</span>
                </div>
                <div class="brand-stat">
                    <span class="brand-stat-label">Margin</span>
                    <span class="brand-stat-value">30%</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="section-title">ASIN Suppression Monitor</div>
    <div class="asin-monitor">
        <div class="asin-monitor-header">
            <div class="asin-health">
                <div class="health-ring">
                    <svg viewBox="0 0 100 100">
                        <circle class="health-ring-bg" cx="50" cy="50" r="40"/>
                        <circle class="health-ring-progress" cx="50" cy="50" r="40"/>
                    </svg>
                    <div class="health-ring-text">
                        <div class="health-percent">1%</div>
                        <div class="health-label">Healthy</div>
                    </div>
                </div>
                <div class="asin-health-info">
                    <h3>All Clear</h3>
                    <p>3 of 166 ASINs visible in Amazon search</p>
                    <div class="last-checked">Last checked: <span>Feb 6, 2026 at 6:57 AM</span></div>
                </div>
            </div>
            <div class="brand-pills">
                <div class="brand-pill">
                    <div class="brand-pill-dot black-owned"></div>
                    <div class="brand-pill-count"><span>48</span> Black Owned</div>
                </div>
                <div class="brand-pill">
                    <div class="brand-pill-dot cardplug"></div>
                    <div class="brand-pill-count"><span>72</span> Card Plug</div>
                </div>
                <div class="brand-pill">
                    <div class="brand-pill-dot kinfolk"></div>
                    <div class="brand-pill-count"><span>46</span> Kinfolk</div>
                </div>
            </div>
        </div>
        
        <div class="suppression-section">
            <div class="suppression-section-header">
                <div class="suppression-section-title">Suppressed ASINs</div>
                <div class="suppression-count-badge clear">0 Issues</div>
            </div>
            
            <div class="all-clear-message">
                <div class="all-clear-icon">✓</div>
                <div class="all-clear-text">All products showing in Amazon search — no action needed</div>
            </div>
        </div>
    </div>
    
    <div class="section-title">Alerts</div>
    <div class="alerts">
        <div class="alert-list">
            <!-- ALERTS_START -->
<div class="alert-item"><div class="alert-dot green"></div><span><strong>No alerts:</strong> Inventory runway is healthy</span></div>
            <!-- ALERTS_END -->
        </div>
    </div>
    
    <div class="updated">
        Data last updated: February 13, 2026 at 03:00 AM CT • ASIN check: Daily at 1 AM (report at 7 AM)
    </div>

    <script>
        console.log('=== DASHBOARD SCRIPT LOADED ===');
        console.log('Current URL:', window.location.href);
        
        (function(){
            console.log('=== MAIN FUNCTION WRAPPER EXECUTED ===');
            
            const paths = {
                range7: '../data/derived/range_7d.json',
                timeSeries: '../data/derived/time_series.json',
                suppressions: '../data/suppression_tracker.csv',
                reorder: '../data/reorder_report.json',
            };

            function usd(n){
                const v = Number(n);
                if (!Number.isFinite(v)) return '—';
                return v.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
            }
            function pct(frac){
                const v = Number(frac);
                if (!Number.isFinite(v)) return '';
                const sign = v > 0 ? '+' : '';
                return `${sign}${(v*100).toFixed(1)}%`;
            }
            function revenueFromSums(sums){
                const s = sums || {};
                const direct = Number(s.Revenue ?? s.Sales ?? s.SalesTotal ?? NaN);
                if (Number.isFinite(direct)) return direct;
                const organic = Number(s.SalesOrganic || 0);
                const ppc = Number(s.SalesPPC || 0);
                const both = organic + ppc;
                if (Number.isFinite(both) && both !== 0) return both;
                return 0;
            }
            function parseCSV(text){
                const lines = (text || '').split(/\r?\n/).filter(l => l.trim().length);
                if (!lines.length) return [];
                const headers = lines[0].split(',').map(h => h.trim());
                return lines.slice(1).map(line => {
                    const cols = [];
                    let cur = '', inQ = false;
                    for (let i=0;i<line.length;i++){
                        const ch = line[i];
                        if (ch === '"') { inQ = !inQ; continue; }
                        if (ch === ',' && !inQ) { cols.push(cur); cur=''; continue; }
                        cur += ch;
                    }
                    cols.push(cur);
                    const row = {};
                    headers.forEach((h, idx) => row[h] = (cols[idx] || '').trim());
                    return row;
                });
            }

            async function fetchJSON(url){
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
                return res.json();
            }
            async function fetchText(url){
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
                return res.text();
            }

            async function computeRevenueTrendFromTimeSeries(ts, latestDate){
                const rows = ts?.data || ts?.rows || {};
                const latest = new Date(String(latestDate) + 'T00:00:00');
                if (!Number.isFinite(latest.getTime())) return { last7: null, prev7: null };

                const dayMs = 86400000;
                let last7 = 0;
                let prev7 = 0;

                for (const k in rows){
                    const row = rows[k];
                    const d = new Date(String(row.date) + 'T00:00:00');
                    if (!Number.isFinite(d.getTime())) continue;
                    const diff = Math.floor((latest - d) / dayMs);
                    if (diff < 0 || diff > 13) continue;

                    const m = row.metrics || row.sums || row;
                    const rev = (Number(m.SalesOrganic||0) + Number(m.SalesPPC||0)) || Number(m.Sales||0) || 0;
                    if (diff <= 6) last7 += rev;
                    else prev7 += rev;
                }

                return { last7, prev7 };
            }

            function setOverallHealth(level, label, title){
                const badge = document.getElementById('overallHealthBadge');
                const text = document.getElementById('overallHealthText');
                if (!badge || !text) return;
                badge.classList.remove('good','warn','bad');
                if (level) badge.classList.add(level);
                text.textContent = label;
                if (title) badge.title = title;
            }

            function addAlert(text, color){
                const list = document.querySelector('.alerts .alert-list');
                if (!list) return;
                const item = document.createElement('div');
                item.className = 'alert-item';
                const dot = document.createElement('div');
                dot.className = 'alert-dot ' + (color || 'yellow');
                const span = document.createElement('span');
                span.innerHTML = text;
                item.appendChild(dot);
                item.appendChild(span);
                // Insert above existing alerts block if present
                const start = list.querySelector('div.alert-item');
                if (start) list.insertBefore(item, start);
                else list.appendChild(item);
            }
            
            function renderSuppressionList(suppressedASINs){
                const container = document.querySelector('.suppression-section');
                if (!container) {
                    console.error('Suppression section container not found');
                    return;
                }
                
                const allClearMsg = container.querySelector('.all-clear-message');
                
                if (!suppressedASINs || suppressedASINs.length === 0) {
                    // Show all-clear message
                    if (allClearMsg) {
                        allClearMsg.style.display = 'block';
                    }
                    // Remove any existing suppressed list
                    const existing = container.querySelector('.suppressed-list');
                    if (existing) existing.remove();
                } else {
                    // Hide all-clear message
                    if (allClearMsg) {
                        allClearMsg.style.display = 'none';
                    }
                    
                    // Remove existing list if present
                    const existing = container.querySelector('.suppressed-list');
                    if (existing) existing.remove();
                    
                    // Create suppressed list
                    let listHTML = '<div class="suppressed-list">';
                    suppressedASINs.forEach(asin => {
                        const name = asin.Name || asin.name || 'Unknown Product';
                        const brand = asin.Brand || asin.brand || '';
                        const asinCode = asin.ASIN || asin.asin || '';
                        const notes = asin.Notes || asin.notes || 'No results found';
                        
                        listHTML += `
                            <div class="suppressed-item">
                                <div class="suppressed-item-header">
                                    <strong>${name}</strong>
                                    <span class="brand-tag">${brand}</span>
                                </div>
                                <div class="suppressed-item-details">
                                    <div>ASIN: ${asinCode}</div>
                                    <div style="color: #f85149;">${notes}</div>
                                </div>
                            </div>
                        `;
                    });
                    listHTML += '</div>';
                    
                    // Insert new list after header
                    const header = container.querySelector('.suppression-section-header');
                    if (header) {
                        header.insertAdjacentHTML('afterend', listHTML);
                    } else {
                        console.error('Suppression section header not found');
                    }
                }
            }

            async function main(){
                try{
                    setOverallHealth('', 'Health: Loading…');

                    const range7 = await fetchJSON(paths.range7);
                    const latest = range7?.meta?.latest_date || range7?.meta?.date_end;

                    const skuRows7 = Object.values(range7?.by_sku || {});
                    const rev7 = skuRows7.reduce((acc, r) => acc + revenueFromSums(r.sums), 0);
                    const revEl = document.getElementById('rev7Value');
                    if (revEl) revEl.textContent = usd(rev7);

                    // Trend vs prior 7 days (best-effort)
                    let frac = null;
                    try{
                        const ts = await fetchJSON(paths.timeSeries);
                        const trend = await computeRevenueTrendFromTimeSeries(ts, latest);
                        if (Number.isFinite(trend.last7) && Number.isFinite(trend.prev7) && trend.prev7 > 0){
                            frac = (trend.last7 - trend.prev7) / trend.prev7;
                            const t = document.getElementById('rev7Trend');
                            if (t){
                                const cls = frac > 0.03 ? 'up' : (frac < -0.07 ? 'down' : '');
                                t.className = 'metric-change ' + cls;
                                t.textContent = `${pct(frac)} vs prior week`;
                            }
                        }
                    } catch(e){
                        // ignore trend if unavailable
                    }

                    // Stockout alerts
                    let stockouts = 0;
                    try{
                        const rr = await fetchJSON(paths.reorder);
                        const items = rr?.items || rr?.rows || rr?.reorder_report || [];
                        if (Array.isArray(items)) stockouts = items.length;
                    } catch(e){ stockouts = 0; }

                    // Suppressions - FIXED VERSION
                    let suppressedCount = 0;
                    let suppressedASINs = [];
                    
                    console.log('=== SUPPRESSION CHECK START ===');
                    console.log('Fetching from:', paths.suppressions);
                    
                    try{
                        const txt = await fetchText(paths.suppressions);
                        console.log('Fetched CSV text, length:', txt.length);
                        
                        const rows = parseCSV(txt);
                        console.log('Parsed CSV rows:', rows.length);
                        console.log('First row sample:', rows[0]);
                        
                        if (rows.length === 0){
                            console.log('No rows found in CSV');
                            suppressedCount = 0;
                            suppressedASINs = [];
                        } else {
                            suppressedASINs = rows.filter(r => {
                                // Check Status field (case-insensitive)
                                const statusField = r.Status || r.status || r.Suppressed || r.suppressed || '';
                                const statusLower = String(statusField).toLowerCase().trim();
                                
                                // If no status field, assume all rows are suppressed (legacy format)
                                if (!statusField) {
                                    console.log('Row with no status field:', r);
                                    return true;
                                }
                                
                                // Check if status indicates suppression
                                const isSuppressed = statusLower === 'suppressed';
                                
                                if (isSuppressed) {
                                    console.log('Found suppressed ASIN:', r.ASIN, r.Name);
                                }
                                
                                return isSuppressed;
                            });
                            suppressedCount = suppressedASINs.length;
                            console.log('=== SUPPRESSED COUNT:', suppressedCount, '===');
                            console.log('Suppressed ASINs:', suppressedASINs);
                        }
                    } catch(e){ 
                        console.error('!!! Error loading suppressions:', e);
                        suppressedCount = 0;
                        suppressedASINs = [];
                    }
                    
                    console.log('About to render suppression list, count:', suppressedCount);
                    console.log('suppressedASINs array:', suppressedASINs);
                    
                    // Render suppressed ASINs list
                    renderSuppressionList(suppressedASINs);
                    
                    console.log('=== SUPPRESSION CHECK END ===');

                    const revenueDown = (typeof frac === 'number') ? (frac < -0.07) : false;

                    // Overall health
                    let level = 'good';
                    const reasons = [];
                    if (stockouts > 0) { level = 'warn'; reasons.push(`${stockouts} stockout alert(s)`); }
                    if (suppressedCount > 0) { level = 'bad'; reasons.push(`${suppressedCount} suppressed ASIN(s)`); }
                    if (revenueDown) { if (level === 'good') level = 'warn'; reasons.push('revenue down vs prior week'); }

                    const label = level === 'bad' ? 'Health: RED' : (level === 'warn' ? 'Health: YELLOW' : 'Health: GREEN');
                    setOverallHealth(level, label, reasons.length ? `Drivers: ${reasons.join(', ')}` : 'No material issues detected');

                    // Add a couple lightweight alert lines (doesn't remove existing alerts)
                    if (suppressedCount > 0) addAlert(`<strong>Suppression:</strong> ${suppressedCount} ASIN(s) suppressed`, 'red');
                    if (stockouts > 0) addAlert(`<strong>Stockout risk:</strong> ${stockouts} SKU(s) flagged in reorder report`, 'yellow');
                    if (revenueDown) addAlert(`<strong>Revenue trend:</strong> down vs prior week`, 'yellow');
                } catch (e){
                    setOverallHealth('bad', 'Health: RED', `Data load failed: ${e.message}`);
                }
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', main);
            else main();
        })();
    </script>
</body>
</html>
